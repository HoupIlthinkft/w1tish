name: Build

on: [push, pull_request]

jobs:
  test_build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Create .env file for CI
      run: |
        cat > .env << EOF
        JWT_SECRET=iWjwGUtt-DUeNb_QU8Oypc4jUZJX_FQflzpDzQTF9vA=
        S3_ENDPOINT=https://s3.w1tish.ru
        S3_AVATARS=https://avatars.w1tish
        S3_ACCESS=fake_access_key
        S3_SECRET=fake_secret_key
        S3_BUKKET=w1tish
        EOF
    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version
    - name: Start services with Docker Compose
      run: |
        docker-compose up -d --build
        docker-compose ps
        sleep 15
    - name: Stop services
      if: always()
      run: docker-compose down -v
